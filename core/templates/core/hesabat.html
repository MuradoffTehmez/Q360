{% extends 'core/base.html' %}
{% load i18n %}

{% block title %}{% trans "Qiymətləndirmə Hesabatı" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <h2>{% trans "Qiymətləndirmə Hesabatı" %}</h2>

    <div>
        {% if can_manage_idp %}
        <a href="{% url 'plan_yarat' detailed_context.ishchi.id detailed_context.dovr.id %}" class="btn btn-info">
            <i class="bi bi-bullseye"></i> {% trans "İnkişaf Planı" %}
        </a>
        {% endif %}
    
        {% if not detailed_context.error %}
        <a href="{% url 'hesabat_pdf_yukle' detailed_context.ishchi.id %}?dovr_id={{ detailed_context.dovr.id }}"
            class="btn btn-danger ms-2" target="_blank">
            <i class="bi bi-file-earmark-pdf"></i> {% trans "PDF Yüklə" %}
        </a>
        {% endif %}
    </div>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="d-flex align-items-center flex-wrap">
            <label for="dovr_id" class="form-label me-2 mb-0">{% trans "Hesabat Dövrünü Seçin:" %}</label>
            <select name="dovr_id" id="dovr_id" class="form-select me-2" style="width: auto;">
                {% for cycle in cycles_for_template %}
                <option value="{{ cycle.id }}" {% if cycle.is_selected %}selected{% endif %}>
                    {{ cycle.ad }}
                </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-secondary btn-sm">{% trans "Göstər" %}</button>
        </form>
    </div>
</div>

<hr>

{% if detailed_context.error %}
<div class="alert alert-warning">
    {{ detailed_context.error }}
</div>
{% else %}
<h4>{{ detailed_context.dovr.ad }} {% trans "Dövrü üçün Detallı Analiz" %}</h4>
<p>
    <strong>{% trans "İşçi:" %}</strong> {{ detailed_context.ishchi.get_full_name }}
</p>

<div class="row">
    <div class="col-md-6 mb-4">
        <h5>{% trans "Kompetensiyalar üzrə Nəticələr" %}</h5>
        <canvas id="radarChart"></canvas>
    </div>
    <div class="col-md-6">
        <h5>{% trans "Ümumi Göstəricilər" %}</h5>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>{% trans "Kompetensiya (Kateqoriya)" %}</th>
                    <th>{% trans "Ortalama Xal (10 üzərindən)" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for netice in detailed_context.kateqoriya_neticeleri %}
                <tr>
                    <td>{{ netice.ad }}</td>
                    <td><strong>{{ netice.ortalama_xal|floatformat:2 }}</strong></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2">{% trans "Bu dövr üçün göstərici tapılmadı." %}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<hr class="my-4">
<h4>{{ detailed_context.dovr.ad }} {% trans "Dövrü üçün Yazılı Rəylər" %}</h4>
{% if detailed_context.yazili_reyler %}
<ul class="list-group">
    {% for rey in detailed_context.yazili_reyler %}
    <li class="list-group-item">"{{ rey }}"</li>
    {% endfor %}
</ul>
{% else %}
<p>{% trans "Bu dövr üçün yazılı rəy qeyd edilməyib." %}</p>
{% endif %}
{% endif %}

<hr class="my-4">

<h4>{% trans "Performans Tarixçəsi (Ümumi Ortalama Bal)" %}</h4>
<div class="card mb-4">
    <div class="card-body">
        <canvas id="trendChart"></canvas>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% if not detailed_context.error %}
        // Radar Chart (Kompetensiyalar)
        const radarCtx = document.getElementById('radarChart');
        if (radarCtx) {
            new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: {{ detailed_context.chart_labels | safe }},
        datasets: [{
            label: '{% trans "Ortalama Xal" %}',
            data: {{ detailed_context.chart_data | safe }},
        fill: true,
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderColor: 'rgb(54, 162, 235)',
                    }]
                },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { r: { suggestedMin: 0, suggestedMax: 10 } }
    }
            });
        }
    {% endif %}

    // Line Chart (Trend Analizi)
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: {{ trend_chart_labels| safe }},
    datasets: [{
        label: '{% trans "Ümumi Ortalama Bal" %}',
        data: {{ trend_chart_data| safe }},
        fill: false,
        borderColor: 'rgb(255, 99, 132)',
        tension: 0.1
                    }]
                },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, suggestedMax: 10 } }
    }
            });
        }
    });
</script>
{% endblock %}
{% extends 'core/base.html' %}

{% block title %}Qiymətləndirmə Hesabatı{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
    <h2>Qiymətləndirmə Hesabatı</h2>
    {% if not detailed_context.error %}
    <a href="{% url 'hesabat_pdf_yukle' detailed_context.ishchi.id %}?dovr_id={{ selected_dovr_id }}"
        class="btn btn-danger" target="_blank">
        PDF Yüklə
    </a>
    {% endif %}
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="get" class="d-flex align-items-center flex-wrap">
            <label for="dovr_id" class="form-label me-2 mb-0">Hesabat Dövrünü Seçin:</label>
            <select name="dovr_id" id="dovr_id" class="form-select me-2" style="width: auto;">
                {% for cycle in cycles_for_template %}
                <option value="{{ cycle.id }}" {% if cycle.is_selected %}selected{% endif %}>
                    {{ cycle.ad }}
                </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-secondary btn-sm">Göstər</button>
        </form>
    </div>
</div>

<hr>

{% if detailed_context.error %}
<div class="alert alert-warning">
    {{ detailed_context.error }}
</div>
{% else %}
<h4>{{ detailed_context.dovr.ad }} Dövrü üçün Detallı Analiz</h4>
<p>
    <strong>İşçi:</strong> {{ detailed_context.ishchi.get_full_name }}
</p>

<div class="row">
    <div class="col-md-6 mb-4">
        <h5>Kompetensiyalar üzrə Nəticələr</h5>
        <canvas id="radarChart"></canvas>
    </div>
    <div class="col-md-6">
        <h5>Ümumi Göstəricilər</h5>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Kompetensiya (Kateqoriya)</th>
                    <th>Ortalama Xal (10 üzərindən)</th>
                </tr>
            </thead>
            <tbody>
                {% for netice in detailed_context.kateqoriya_neticeleri %}
                <tr>
                    <td>{{ netice.ad }}</td>
                    <td><strong>{{ netice.ortalama_xal|floatformat:2 }}</strong></td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="2">Bu dövr üçün göstərici tapılmadı.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<hr class="my-4">
<h4>{{ detailed_context.dovr.ad }} Dövrü üçün Yazılı Rəylər</h4>
{% if detailed_context.yazili_reyler %}
<ul class="list-group">
    {% for rey in detailed_context.yazili_reyler %}
    <li class="list-group-item">"{{ rey }}"</li>
    {% endfor %}
</ul>
{% else %}
<p>Bu dövr üçün yazılı rəy qeyd edilməyib.</p>
{% endif %}
{% endif %}

<hr class="my-4">

<h4>Performans Tarixçəsi (Ümumi Ortalama Bal)</h4>
<div class="card mb-4">
    <div class="card-body">
        <canvas id="trendChart"></canvas>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        {% if not detailed_context.error %}
        // Radar Chart (Kompetensiyalar)
        const radarCtx = document.getElementById('radarChart');
        if (radarCtx) {
            new Chart(radarCtx, {
                type: 'radar',
                data: {
                    labels: {{ detailed_context.chart_labels | safe }},
        datasets: [{
            label: 'Ortalama Xal',
            data: {{ detailed_context.chart_data | safe }},
        fill: true,
        backgroundColor: 'rgba(54, 162, 235, 0.2)',
        borderColor: 'rgb(54, 162, 235)',
                        }]
                    },
        options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: { r: { suggestedMin: 0, suggestedMax: 10 } }
    }
                });
            }
    {% endif %}

    // Line Chart (Trend Analizi)
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: {{ trend_chart_labels| safe }},
    datasets: [{
        label: 'Ümumi Ortalama Bal',
        data: {{ trend_chart_data| safe }},
        fill: false,
        borderColor: 'rgb(255, 99, 132)',
        tension: 0.1
                        }]
                    },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                scales: { y: { beginAtZero: true, suggestedMax: 10 } }
    }
                });
            }
        });
</script>
{% endblock %}
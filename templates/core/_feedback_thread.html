{% for item in feedback_items %}
<div class="card my-2" style="margin-left: {{ item.level|default:0 }}px;">
    <div class="card-body">
        <p class="card-text">{{ item.content }}</p>
        <small class="text-muted">
            By:
            {% if item.is_anonymous %}
                Anonymous User
            {% else %}
                <a href="{% url 'user_profile_detail' item.author.pk %}">{{ item.author.get_full_name }}</a>
            {% endif %}
            on {{ item.created_at }}
        </small>
        <button class="btn btn-sm btn-link" onclick="showReplyForm({{ item.id }})">Reply</button>

        <div id="reply-form-{{ item.id }}" style="display:none;" class="mt-2">
            <form class="reply-form" data-parent-id="{{ item.id }}">
                <div class="mb-2">
                    <textarea class="form-control" rows="2" required></textarea>
                </div>
                 <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="is-anonymous-{{ item.id }}">
                    <label class="form-check-label" for="is-anonymous-{{ item.id }}">
                        Post as Anonymous
                    </label>
                </div>
                <button type="submit" class="btn btn-sm btn-primary">Submit Reply</button>
            </form>
        </div>
    </div>
    {% if item.replies.all %}
        {% include 'core/_feedback_thread.html' with feedback_items=item.replies.all %}
    {% endif %}
</div>
{% endfor %}

<script>
function showReplyForm(id) {
    const form = document.getElementById('reply-form-' + id);
    if (form.style.display === 'none') {
        form.style.display = 'block';
    } else {
        form.style.display = 'none';
    }
}

document.querySelectorAll('.reply-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const parentId = this.dataset.parentId;
        const content = this.querySelector('textarea').value;
        const isAnonymous = this.querySelector('input[type=checkbox]').checked;
        const unitId = {{ unit.id }};

        fetch("{% url 'post_feedback' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                content: content,
                is_anonymous: isAnonymous,
                unit_id: unitId,
                parent_id: parentId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'ok') {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        });
    });
});
</script>
